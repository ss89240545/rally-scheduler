
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Multiple / Enemy Rally Scheduler v3.0</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body { background: #f8fafc; }
      input[type=number]::-webkit-outer-spin-button,
      input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
      input[type=number] { -moz-appearance: textfield; }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel" data-presets="env,react">
      const { useState, useEffect, useMemo } = React;

      const LABELS = ["A","B","C","D","E","F"];
      const toSec = (min, sec) => Math.max(0, (Number(min)||0)*60 + (Number(sec)||0));
      const clamp0to59 = (sec) => Math.min(59, Math.max(0, Math.floor(Number(sec)||0)));
      const pad2 = (n) => String(n).padStart(2,"0");
      const fmtHMS = (totalSec) => {
        const sign = totalSec < 0 ? "-" : "";
        const s = Math.abs(totalSec);
        const h = Math.floor(s/3600);
        const m = Math.floor((s%3600)/60);
        const sec = Math.floor(s%60);
        return `${sign}${h>0 ? pad2(h)+":" : ""}${pad2(m)}:${pad2(sec)}`;
      };

      const emptyRow = (label) => ({ label, name:`Rally ${label}`, min:"", sec:"", arrivalDelay:"" });

      function computeOffsets(rows){
        const details = rows.map(r=>{
          const T = toSec(r.min, r.sec);
          const delay = Math.max(0, Math.min(10, Math.floor(Number(r.arrivalDelay)||0)));
          return { label:r.label, name:r.name||`Rally ${r.label}`, travelSec:T, arrivalDelay:delay, startRelToArrival0: delay - T };
        });
        const minStart = Math.min(...details.map(d=>d.startRelToArrival0));
        const first = details.find(d=>d.startRelToArrival0===minStart);
        const offsets = details.map(d=>({
          label:d.label, name:d.name, offsetSec: d.startRelToArrival0 - minStart
        })).sort((a,b)=>a.offsetSec-b.offsetSec);
        return { firstStarter: first ? first.name : "", offsets };
      }

      function MultipleRalliesScheduler(){
        const [rows, setRows] = useState([emptyRow("A"), emptyRow("B")]);
        const [result, setResult] = useState(null);
        const canCalc = useMemo(()=>rows.every(r => (r.min!=="" || r.sec!=="" || r.arrivalDelay!=="")), [rows]);

        const handleCalc = () => {
          const normalized = rows.map(r=>({
            ...r,
            sec: clamp0to59(r.sec),
            min: Math.max(0, Math.floor(Number(r.min)||0)),
            arrivalDelay: Math.max(0, Math.min(10, Math.floor(Number(r.arrivalDelay)||0))),
          }));
          setResult(computeOffsets(normalized));
        };

        const handleAdd = () => {
          if(rows.length < LABELS.length) setRows([...rows, emptyRow(LABELS[rows.length])]);
        };

        const handleRemove = (idx) => {
          if(rows.length <= 2) return;
          setRows(rows.filter((_,i)=>i!==idx));
        };

        return (
          <div className="space-y-6">
            <div className="flex flex-col sm:flex-row items-center gap-3 justify-center">
              <button onClick={handleAdd} className="rounded-xl w-full sm:w-auto px-4 py-2 border text-sm bg-gray-50 hover:bg-gray-100">Add Rally</button>
            </div>

            <section className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
              {rows.map((r, idx)=>(
                <div key={`${r.label}-${idx}`} className="border rounded-xl p-4 space-y-3">
                  <div className="flex items-center justify-between">
                    <span className="text-sm md:text-base text-gray-600">Rally leader {r.label}</span>
                    {rows.length>2 && <button className="text-xs text-red-600 hover:underline" onClick={()=>handleRemove(idx)}>Remove</button>}
                  </div>
                  <label className="block text-sm font-medium">Name</label>
                  <input className="w-full rounded-lg border px-3 py-2 text-sm"
                         placeholder={`e.g. Rally ${r.label}`}
                         value={r.name}
                         onChange={e=>setRows(v=>{const n=[...v]; n[idx].name = e.target.value; return n;})}/>
                  <div className="grid grid-cols-2 gap-3">
                    <div>
                      <label className="block text-sm font-medium">Minutes</label>
                      <input type="number" min={0} className="w-full rounded-lg border px-3 py-2 text-sm"
                             value={r.min}
                             onChange={e=>setRows(v=>{const n=[...v]; n[idx].min = e.target.value; return n;})}/>
                    </div>
                    <div>
                      <label className="block text-sm font-medium">Seconds (0â€“59)</label>
                      <input type="number" min={0} max={59} className="w-full rounded-lg border px-3 py-2 text-sm"
                             value={r.sec}
                             onChange={e=>setRows(v=>{const n=[...v]; n[idx].sec = e.target.value; return n;})}/>
                    </div>
                  </div>
                  <div>
                    <label className="block text-sm font-medium">Arrival Delay (seconds)</label>
                    <input type="number" min={0} max={10} className="w-full rounded-lg border px-3 py-2 text-sm"
                           value={r.arrivalDelay}
                           onChange={e=>setRows(v=>{const n=[...v]; n[idx].arrivalDelay = e.target.value; return n;})}/>
                  </div>
                </div>
              ))}
            </section>

            <div className="flex items-center justify-center">
              <button onClick={handleCalc} disabled={!canCalc} className="rounded-xl w-full sm:w-auto px-6 py-3 bg-black text-white text-sm hover:opacity-90">Calculate</button>
            </div>

            {result && (
              <div className="border rounded-xl p-4 text-sm">
                <h2 className="font-semibold mb-2 text-base">Result Summary</h2>
                <p className="mb-1">First to start: <span className="font-bold">{result.firstStarter}</span></p>
                <ul className="space-y-1">
                  {result.offsets.map((o,i)=>(
                    <li key={`${o.label}-${i}`}>
                      {i===0 ? (<><span className="font-medium">{o.name}</span>: Base (t = 0s)</>) : (<><span className="font-medium">{o.name}</span>: Start <span className="font-bold">+{o.offsetSec}</span> seconds later</>)}
                    </li>
                  ))}
                </ul>
              </div>
            )}
          </div>
        );
      }

      const emptyLeader = (idx) => ({ label: LABELS[idx] || String.fromCharCode(65 + idx), name: `Rally ${LABELS[idx] || String.fromCharCode(65 + idx)}`, min:"", sec:"", delay:"" });

      function EnemysRallyScheduler({ state, setState }){
        const [localState, setLocalState] = useState(state ?? { enemyMin:"", enemySec:"", leaders:[emptyLeader(0)] });
        const s = state ?? localState;
        const setS = setState ?? setLocalState;

        const { enemyMin, enemySec, leaders } = s;
        const [utc, setUtc] = useState(new Date().toISOString().slice(11,19));
        const [results, setResults] = useState([]);

        useEffect(()=>{
          const t = setInterval(()=>setUtc(new Date().toISOString().slice(11,19)), 1000);
          return ()=>clearInterval(t);
        },[]);

        const addLeader = () => setS(p=>({ ...p, leaders:[...p.leaders, emptyLeader(p.leaders.length)] }));
        const removeLeader = (i) => setS(p=>{
          if (p.leaders.length <= 1) return p;
          return { ...p, leaders: p.leaders.filter((_,x)=>x!==i) };
        });

        const handleCalc = () => {
          const now = new Date();
          const enemyTravel = toSec(enemyMin, enemySec);
          const rallyPrep = 300;
          const enemyOpen = now;
          const enemyArrival = new Date(now.getTime() + (enemyTravel + rallyPrep) * 1000);

          const out = s.leaders.map(L=>{
            const T = toSec(L.min, L.sec);
            const delay = Math.max(0, Math.min(10, Math.floor(Number(L.delay)||0)));
            const leaderStart = new Date(enemyArrival.getTime() - (rallyPrep + T + delay) * 1000);
            const shouldStartInSec = Math.round((leaderStart.getTime() - now.getTime())/1000);
            return { label:L.label, name:L.name, enemyOpen, enemyArrival, leaderStart, shouldStartInSec };
          });
          setResults(out);
        };

        return (
          <div className="space-y-6">
            <div className="text-center text-sm text-gray-600">Current UTC Time: <span className="font-semibold">{utc}</span></div>

            <div className="border rounded-xl p-4 space-y-3">
              <h2 className="font-semibold">Enemy Rally</h2>
              <div className="grid grid-cols-2 gap-3">
                <input type="number" className="border rounded px-3 py-2 text-sm" placeholder="Minutes" value={enemyMin} onChange={e=>setS(p=>({...p, enemyMin: e.target.value}))} />
                <input type="number" className="border rounded px-3 py-2 text-sm" placeholder="Seconds" value={enemySec} onChange={e=>setS(p=>({...p, enemySec: e.target.value}))} />
              </div>
              <p className="text-xs text-gray-500">Enemy arrival = Now (UTC) + enemy travel + 5 min prep.</p>
            </div>

            {leaders.map((L,i)=>(
              <div key={i} className="border rounded-xl p-4 space-y-3">
                <div className="flex justify-between items-center">
                  <h2 className="font-semibold">Rally Leader {L.label}</h2>
                  {leaders.length>1 && <button className="text-xs text-red-600 hover:underline" onClick={()=>removeLeader(i)}>Remove</button>}
                </div>

                <input className="w-full border rounded px-3 py-2 text-sm" placeholder={`e.g. Rally ${L.label}`} value={L.name}
                       onChange={e=>setS(p=>{ const next=[...p.leaders]; next[i] = { ...next[i], name:e.target.value }; return { ...p, leaders: next }; })} />

                <div className="grid grid-cols-2 gap-3">
                  <input type="number" className="border rounded px-3 py-2 text-sm" placeholder="Minutes" value={L.min}
                         onChange={e=>setS(p=>{ const next=[...p.leaders]; next[i] = { ...next[i], min:e.target.value }; return { ...p, leaders: next }; })} />
                  <input type="number" className="border rounded px-3 py-2 text-sm" placeholder="Seconds (0â€“59)" value={L.sec}
                         onChange={e=>setS(p=>{ const next=[...p.leaders]; next[i] = { ...next[i], sec:e.target.value }; return { ...p, leaders: next }; })} />
                </div>

                <input type="number" className="border rounded px-3 py-2 text-sm" placeholder="Arrival Delay (0â€“10s)" value={L.delay}
                       onChange={e=>setS(p=>{ const next=[...p.leaders]; next[i] = { ...next[i], delay:e.target.value }; return { ...p, leaders: next }; })} />
              </div>
            ))}

            <div className="flex justify-center gap-3">
              <button onClick={addLeader} className="rounded-xl px-4 py-2 border bg-gray-50 hover:bg-gray-100 text-sm">Add Rally Leader</button>
              <button onClick={handleCalc} className="rounded-xl px-6 py-3 bg-black text-white text-sm hover:opacity-90">Calculate</button>
            </div>

            {results.length>0 && (
              <div className="border rounded-xl p-4 space-y-3 text-sm">
                <h3 className="font-semibold">Results</h3>
                {results.map((r,i)=>(
                  <div key={i} className="space-y-1">
                    <p className="font-medium">Leader {r.label} {r.name && `(${r.name})`}</p>
                    <ul className="list-disc pl-5">
                      <li>Enemy rally opened (UTC): <b>{r.enemyOpen.toISOString().slice(11,19)}</b></li>
                      <li>Enemy arrival (UTC): <b>{r.enemyArrival.toISOString().slice(11,19)}</b></li>
                      <li>Leader rally open (UTC): <b>{r.leaderStart.toISOString().slice(11,19)}</b></li>
                      <li>After enemy opened now, you should open in: <b>{fmtHMS(r.shouldStartInSec)}</b>{r.shouldStartInSec<=0 && <span className="text-red-600"> (Start immediately)</span>}</li>
                    </ul>
                  </div>
                ))}
              </div>
            )}
          </div>
        );
      }

      function App(){
        const [mode, setMode] = useState("main");
        const [enemyState, setEnemyState] = useState({ enemyMin:"", enemySec:"", leaders:[emptyLeader(0)] });

        return (
          <div className="min-h-screen bg-gray-50 flex items-start justify-center p-4 md:p-6">
            <div className="w-full max-w-2xl md:max-w-4xl bg-white rounded-2xl shadow p-4 md:p-6 space-y-6">
              <div className="flex justify-between items-center">
                <h1 className="text-xl md:text-2xl font-bold">{mode==="main" ? "Multiple Rallies Scheduler" : "Enemy's Rally Scheduler"}</h1>
                <button onClick={()=>setMode(mode==="main" ? "enemy" : "main")} className="rounded-xl px-3 py-2 border bg-gray-50 hover:bg-gray-100 text-sm">
                  {mode==="main" ? "Switch to Enemyâ€™s Rally" : "Switch to Rally Scheduler"}
                </button>
              </div>

              {mode==="main" ? <MultipleRalliesScheduler /> : <EnemysRallyScheduler state={enemyState} setState={setEnemyState} />}

              <footer className="text-xs text-gray-400 pt-4 text-center">
                v3.0 Â· Dual mode with safe fallback and 5-min enemy prep.<br />Created by <span className="font-semibold">Kingshot #341 Ecko</span>
              </footer>
            </div>
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
